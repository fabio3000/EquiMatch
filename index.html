<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EquiMatch | Gesunde Arbeitswelt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased min-h-screen">

    <!-- Hier wird die App hineingeladen -->
    <div id="app" class="pb-12">
        <div class="text-center mt-20 text-teal-600 font-bold animate-pulse">Lade EquiMatch...</div>
    </div>

    <!-- Firebase & App Logik -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURATION ---
        // Wenn du das auf GitHub hostest, trage hier später deine eigenen Firebase-Daten ein!
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : {
            // Dummy Config für GitHub
            apiKey: "dummy-key",
            projectId: "equimatch-demo",
            appId: "1:123:web:456"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'equimatch-github-v1';

        let appInit, auth, db;
        try {
            appInit = initializeApp(firebaseConfig);
            auth = getAuth(appInit);
            db = getFirestore(appInit);
        } catch(e) {
            console.warn("Firebase Setup Fehler (Offline Modus aktiviert):", e);
        }

        // --- STATE MANAGEMENT ---
        let state = {
            user: null,
            view: 'loading', // loading, role_select, talent_onboarding, company_onboarding, dashboard
            role: null,      // talent, company
            profile: null,
            talents: [],
            companies: [],
            applications: []
        };

        const appDiv = document.getElementById('app');

        // Initialer Render-Aufruf, damit der Bildschirm nie weiß bleibt
        render();

        // --- AUTHENTIFIZIERUNG ---
        async function initAuth() {
            try {
                if (auth) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    throw new Error("Kein Auth-Modul");
                }
            } catch (error) {
                console.warn("Offline Demo Modus aktiviert.");
                state.user = { uid: 'local-user-' + Math.random().toString(36).substr(2, 9) };
                state.view = 'role_select';
                render();
            }
        }

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    loadData();
                } else {
                    state.view = 'role_select';
                    render();
                }
            });
        } else {
            // Falls auth nicht geladen werden konnte, direkt starten
            initAuth();
        }

        // --- DATEN LADEN ---
        function loadData() {
            if (!state.user) return;
            const getColRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

            try {
                onSnapshot(getColRef('talents'), (snap) => {
                    state.talents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    checkProfile(); render();
                }, (err) => console.error(err));

                onSnapshot(getColRef('companies'), (snap) => {
                    state.companies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    checkProfile(); render();
                }, (err) => console.error(err));

                onSnapshot(getColRef('applications'), (snap) => {
                    state.applications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                }, (err) => console.error(err));
            } catch (e) {
                // Fallback falls DB fehlt
                state.view = 'role_select';
                render();
            }
        }

        function checkProfile() {
            if (!state.user) return;
            const myTalent = state.talents.find(t => t.uid === state.user.uid);
            const myCompany = state.companies.find(c => c.uid === state.user.uid);
            
            if (myTalent) { state.profile = myTalent; state.role = 'talent'; state.view = 'dashboard'; }
            else if (myCompany) { state.profile = myCompany; state.role = 'company'; state.view = 'dashboard'; }
            else if (state.view === 'loading') { state.view = 'role_select'; }
        }

        // --- GLOBALE AKTIONEN (Für HTML Buttons) ---
        window.setView = (view) => { state.view = view; render(); };
        
        window.saveTalent = async () => {
            if (!state.user) return;
            const data = {
                uid: state.user.uid,
                title: document.getElementById('t_title').value,
                experience: document.getElementById('t_exp').value,
                salary: document.getElementById('t_salary').value,
                health: document.getElementById('t_health').value,
                about: document.getElementById('t_about').value,
            };
            try {
                if(!db) throw new Error("Offline");
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'talents', state.user.uid), data);
            } catch(e) { 
                // Offline Fallback: Direkt im Browser speichern
                state.profile = data;
                state.role = 'talent';
                state.view = 'dashboard';
                state.talents.push(data);
                render();
            }
        };

        window.saveCompany = async () => {
            if (!state.user) return;
            const data = {
                uid: state.user.uid,
                name: document.getElementById('c_name').value,
                culture: document.getElementById('c_culture').value,
                perks: document.getElementById('c_perks').value,
            };
            try {
                if(!db) throw new Error("Offline");
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', state.user.uid), data);
            } catch(e) { 
                // Offline Fallback
                state.profile = data;
                state.role = 'company';
                state.view = 'dashboard';
                state.companies.push(data);
                
                // Demo Talent hinzufügen, damit die Firma jemanden zum Anschreiben hat
                state.talents.push({ uid: 'demo-1', title: 'UX Designer', experience: 4, salary: 55000, health: 8, about: 'Transparente Kommunikation ist mir wichtig.' });
                render();
            }
        };

        window.applyToTalent = async (talentId) => {
            if (!state.user || !state.profile) return;
            const msg = prompt("Nachricht an das Talent (Warum passt eure Kultur?):");
            if (!msg) return;
            
            const appData = {
                id: 'app-' + Math.random().toString(36).substr(2, 9),
                companyId: state.user.uid,
                companyName: state.profile.name,
                talentId: talentId,
                message: msg,
                status: 'pending'
            };

            try {
                if(!db) throw new Error("Offline");
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'applications'), appData);
            } catch(e) { 
                state.applications.push(appData);
                render();
                alert("Anfrage erfolgreich simuliert! (Offline Demo)");
            }
        };

        window.updateAppStatus = async (appIdToUpdate, status) => {
            try {
                if(!db) throw new Error("Offline");
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'applications', appIdToUpdate), { status });
            } catch(e) { 
                const application = state.applications.find(a => a.id === appIdToUpdate || a.talentId === state.user.uid);
                if(application) application.status = status;
                render();
            }
        };

        // --- UI RENDERER ---
        function render() {
            let html = `
                <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                    <div class="text-xl font-bold text-teal-600">EquiMatch.</div>
                    <div class="text-sm font-medium text-slate-500">${state.profile?.name || state.profile?.title || 'Gast'}</div>
                </nav>
                <div class="max-w-5xl mx-auto p-6 mt-6">
            `;

            if (state.view === 'loading') {
                html += `<div class="text-center mt-20 text-teal-600 font-bold">Verbinde zur sicheren Umgebung...</div>`;
            } 
            else if (state.view === 'role_select') {
                html += `
                    <div class="text-center mb-12 mt-10">
                        <h1 class="text-4xl font-bold text-slate-900 mb-4">Willkommen bei <span class="text-teal-600">EquiMatch</span></h1>
                        <p class="text-slate-600">Der Jobmarkt, der mentale Gesundheit und Begegnungen auf Augenhöhe priorisiert.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onclick="window.setView('talent_onboarding')" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:border-teal-400 transition text-left">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Ich bin ein Talent</h2>
                            <p class="text-slate-500">Anonymes Profil erstellen. Firmen bewerben sich bei dir.</p>
                        </button>
                        <button onclick="window.setView('company_onboarding')" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:border-indigo-400 transition text-left">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Wir sind ein Unternehmen</h2>
                            <p class="text-slate-500">Talente finden, die zu eurer gesunden Unternehmenskultur passen.</p>
                        </button>
                    </div>
                `;
            }
            else if (state.view === 'talent_onboarding') {
                html += `
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 max-w-xl mx-auto">
                        <button onclick="window.setView('role_select')" class="text-slate-400 text-sm mb-6">← Zurück</button>
                        <h2 class="text-2xl font-bold mb-2">Dein anonymes Profil</h2>
                        <p class="text-slate-500 mb-6">Schütze deine Privatsphäre.</p>
                        
                        <input id="t_title" type="text" placeholder="Beruf (z.B. Designer)" class="w-full p-3 bg-slate-50 rounded-xl mb-4 border border-slate-200">
                        <div class="flex gap-4 mb-4">
                            <input id="t_exp" type="number" placeholder="Jahre Erfahrung" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <input id="t_salary" type="number" placeholder="Wunschgehalt (€)" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200">
                        </div>
                        <label class="block text-sm font-semibold mb-1">Wichtigkeit Mentale Gesundheit (1-10)</label>
                        <input id="t_health" type="range" min="1" max="10" value="8" class="w-full accent-teal-600 mb-4">
                        <textarea id="t_about" placeholder="Was brauchst du für ein gesundes Arbeitsumfeld?" class="w-full p-3 bg-slate-50 rounded-xl mb-6 border border-slate-200 h-24"></textarea>
                        
                        <button onclick="window.saveTalent()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl hover:bg-teal-700">Profil aktivieren</button>
                    </div>
                `;
            }
            else if (state.view === 'company_onboarding') {
                html += `
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 max-w-xl mx-auto">
                        <button onclick="window.setView('role_select')" class="text-slate-400 text-sm mb-6">← Zurück</button>
                        <h2 class="text-2xl font-bold mb-2">Unternehmens-Profil</h2>
                        <p class="text-slate-500 mb-6">Zeigt Talenten, wie wichtig euch Gesundheit ist.</p>
                        
                        <input id="c_name" type="text" placeholder="Unternehmensname" class="w-full p-3 bg-slate-50 rounded-xl mb-4 border border-slate-200">
                        <label class="block text-sm font-semibold mb-1">Euer Culture Score (1-10)</label>
                        <input id="c_culture" type="range" min="1" max="10" value="7" class="w-full accent-indigo-600 mb-4">
                        <textarea id="c_perks" placeholder="Was tut ihr für die Gesundheit des Teams? (z.B. 4-Tage-Woche)" class="w-full p-3 bg-slate-50 rounded-xl mb-6 border border-slate-200 h-24"></textarea>
                        
                        <button onclick="window.saveCompany()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Als Unternehmen registrieren</button>
                    </div>
                `;
            }
            else if (state.view === 'dashboard' && state.role === 'talent') {
                const myApps = state.applications.filter(a => a.talentId === state.user.uid);
                html += `
                    <h2 class="text-2xl font-bold mb-6">Eingehende Bewerbungen von Firmen</h2>
                    <div class="space-y-4">
                `;
                if(myApps.length === 0) html += `<div class="p-8 bg-white rounded-3xl text-center text-slate-500">Noch keine Anfragen. Firmen bewerben sich bei dir, sobald es ein Culture-Match gibt.</div>`;
                
                myApps.forEach(app => {
                    html += `
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <h3 class="font-bold text-lg">${app.companyName} möchte dich kennenlernen!</h3>
                            <p class="text-slate-600 bg-slate-50 p-3 rounded-xl my-3 italic">"${app.message}"</p>
                            ${app.status === 'pending' ? `
                                <div class="flex gap-2">
                                    <button onclick="window.updateAppStatus('${app.id}', 'accepted')" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm">Kontakt freigeben</button>
                                    <button onclick="window.updateAppStatus('${app.id}', 'rejected')" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm">Absagen</button>
                                </div>
                            ` : `<span class="bg-slate-100 px-3 py-1 rounded-full text-sm">${app.status}</span>`}
                        </div>
                    `;
                });
                html += `</div>`;
            }
            else if (state.view === 'dashboard' && state.role === 'company') {
                html += `
                    <div class="mb-6 bg-indigo-50 p-4 rounded-xl">
                        <h2 class="text-lg font-bold text-indigo-900">Talente finden</h2>
                        <p class="text-sm text-indigo-700">Dein Score: ${state.profile.culture}/10. Bewirb dich bei passenden Talenten.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                `;
                
                state.talents.forEach(t => {
                    const match = 100 - Math.abs(t.health - state.profile.culture) * 10;
                    html += `
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded">Anonymes Talent</span>
                                    <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">${match}% Health Match</span>
                                </div>
                                <h3 class="font-bold text-lg">${t.title}</h3>
                                <p class="text-sm text-slate-500 mb-3">${t.experience} Jahre Erfahrung | ${t.salary}€</p>
                                <p class="text-sm text-slate-700 italic mb-4">"${t.about}"</p>
                            </div>
                            <button onclick="window.applyToTalent('${t.uid}')" class="bg-indigo-600 text-white w-full py-2 rounded-xl text-sm font-bold hover:bg-indigo-700">Beim Talent bewerben</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            html += `</div>`;
            appDiv.innerHTML = html;
        }

    </script>
</body>
</html>



